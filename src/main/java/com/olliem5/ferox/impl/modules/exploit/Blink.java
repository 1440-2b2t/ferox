package com.olliem5.ferox.impl.modules.exploit;

import com.olliem5.ferox.api.module.Category;
import com.olliem5.ferox.api.module.FeroxModule;
import com.olliem5.ferox.api.module.Module;
import com.olliem5.ferox.api.setting.Setting;
import com.olliem5.ferox.impl.events.PacketEvent;
import com.olliem5.pace.annotation.PaceHandler;
import net.minecraft.client.entity.EntityOtherPlayerMP;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.network.play.client.CPacketPlayer;

import java.util.LinkedList;
import java.util.Queue;

/**
 * @author olliem5
 */

@FeroxModule(name = "Blink", description = "Hides your movement for a short time", category = Category.Exploit)
public final class Blink extends Module {
    public static final Setting<Boolean> spawnPlayerModel = new Setting<>("Player Model", "Spawns a player model of you where you enabled the module", true);

    public Blink() {
        this.addSettings(
                spawnPlayerModel
        );
    }

    private final Queue<CPacketPlayer> packets = new LinkedList<>();

    private EntityOtherPlayerMP playerModel = null;

    @Override
    public void onEnable() {
        if (nullCheck()) return;

        if (spawnPlayerModel.getValue()) {
            playerModel = new EntityOtherPlayerMP(mc.world, mc.getSession().getProfile());

            if (playerModel != null) {
                playerModel.copyLocationAndAnglesFrom(mc.player);
                playerModel.rotationYawHead = mc.player.rotationYawHead;
            }

            mc.world.addEntityToWorld(playerModel.entityId, playerModel);
        }
    }

    @Override
    public void onDisable() {
        if (nullCheck()) return;

        while (!packets.isEmpty()) {
            mc.player.connection.sendPacket(packets.poll());
        }

        EntityPlayer entityPlayer = mc.player;

        if (entityPlayer != null) {
            if (spawnPlayerModel.getValue()) {
                mc.world.removeEntityFromWorld(playerModel.getEntityId());
            }
        }
    }

    @PaceHandler
    public void onPacketSend(PacketEvent.Send event) {
        if (nullCheck()) return;

        if (event.getPacket() instanceof CPacketPlayer) {
            event.setCancelled(true);
            packets.add((CPacketPlayer) event.getPacket());
        }
    }

    @Override
    public String getArraylistInfo() {
        return packets.size() + "";
    }
}
